(function(){"use strict";function S(t,o,m=!1){const s=t.length;let r=0;for(let e=1;e<s;e++){let l=s>>1;for(;r&l;)r^=l,l>>=1;r^=l,e<r&&([t[e],t[r]]=[t[r],t[e]],[o[e],o[r]]=[o[r],o[e]])}for(let e=2;e<=s;e<<=1){const l=2*Math.PI/e*(m?-1:1),w=Math.cos(l),M=Math.sin(l);for(let c=0;c<s;c+=e){let u=1,F=0;const i=e>>1;for(let b=0;b<i;b++){const v=t[c+b],E=o[c+b],R=t[c+b+i],d=o[c+b+i],V=R*u-d*F,T=R*F+d*u;t[c+b]=v+V,o[c+b]=E+T,t[c+b+i]=v-V,o[c+b+i]=E-T;const j=u*w-F*M,C=u*M+F*w;u=j,F=C}}}if(m)for(let e=0;e<s;e++)t[e]/=s,o[e]/=s}function Y(t,o){const m=t.length,s=o.length,r=m+s-1;let e=1;for(;e<r;)e<<=1;const l=new Float64Array(e),w=new Float64Array(e),M=new Float64Array(e),c=new Float64Array(e);l.set(t),M.set(o),S(l,w,!1),S(M,c,!1);const u=new Float64Array(e),F=new Float64Array(e);for(let i=0;i<e;i++)u[i]=l[i]*M[i]-w[i]*c[i],F[i]=l[i]*c[i]+w[i]*M[i];return S(u,F,!0),u.subarray(0,r)}function Z(t){const o=Math.max(1e-6,t.dt||.001),m=Math.max(o,t.duration||5),s=Math.max(1,Math.floor(m/o)),r=Number.isFinite(t.rho_disc)?t.rho_disc:7800,e=Number.isFinite(t.cp_disc)?t.cp_disc:460;let l=Number.isFinite(t.k_disc)?t.k_disc:50;l<=0&&(l=1e-12);const w=l/(r*e),M=Number.isFinite(t.T0)?t.T0:20,c=Number.isFinite(t.R)?t.R:.3,u=t.scenario||"Constant Speed",F=Number.isFinite(t.wheelFrequency)?t.wheelFrequency:10,i=Number.isFinite(t.aNeg)?t.aNeg:-1,b=Number.isFinite(t.aPos)?t.aPos:2,v=Math.max(F,1e-6)*2*Math.PI*c,E=.05,R=.001,d=E*c*1,T=(Number.isFinite(t.Edensity)?t.Edensity:.05)*d,j=d*R,C=Number.isFinite(t.thermalVolumeFactor)?Math.max(1e-6,t.thermalVolumeFactor):1,$=j*C,p=Number.isFinite(t.mu)?Math.max(0,t.mu):0,tt=Number.isFinite(t.FN)?Math.max(0,t.FN):0,et=c*E,nt=p*tt*et,ot=Number.isFinite(t.frictionToHeat)?Math.max(0,Math.min(1,t.frictionToHeat)):1,ct=Number.isFinite(t.kLoss)?Math.max(0,t.kLoss):20;let q=Number.isFinite(t.I_disc)?t.I_disc:null;q||(q=.5*(Number.isFinite(t.wheelMass)?t.wheelMass:100)*c*c);const Q=Math.max(1,Math.min(2,Number.isFinite(t.nBK)?t.nBK:1));let H=Q===1?[0]:[0,Math.PI];const it=Number.isFinite(t.phi_obs)?t.phi_obs:0;H=H.map(n=>(n-it+2*Math.PI)%(2*Math.PI));const k=H.map(n=>n),U=Number.isFinite(t.distance)?t.distance:.001,st=U*U,N=new Float64Array(s),K=new Float64Array(s);let y=u==="Acceleration with Brake"?0:F,_=2*Math.PI*y,L=0;for(let n=0;n<s;n++){if(u==="Emergency Brake"){const h=i/c;_=Math.max(0,_+h*o),y=_/(2*Math.PI)}else if(u==="Acceleration with Brake"){const h=b/c;_=Math.max(0,_+h*o),y=_/(2*Math.PI)}else y=F,_=2*Math.PI*F;const a=_*c;K[n]=a;const f=y*2*Math.PI*o,P=L;L+=f;for(let h=0;h<Q;h++){for(;k[h]<=P;)k[h]+=2*Math.PI;if(P<k[h]&&k[h]<=L){const B=nt;let g=a/(v||1e-9);(!isFinite(g)||g<0)&&(g=0);const J=T*g,I=ot*B,x=J+I;if(x>0&&(N[n]+=x/o),u!=="Constant Speed"){const O=.5*q*_*_,A=Math.max(0,O-B);_=A>0?Math.sqrt(2*A/q):0,y=_/(2*Math.PI),K[n]=_*c}k[h]+=2*Math.PI}}}const W=new Float64Array(s);for(let n=0;n<s;n++){const a=n===0?o*.5:n*o,f=Math.pow(4*Math.PI*w*a,1.5);W[n]=f>0?Math.exp(-st/(4*w*a))/(f*r*e):0}let D=Y(N,W);const lt=ct*d/(r*$*e);for(let n=0;n<s;n++){let a=M+D[n];a=M+(a-M)*Math.exp(-lt*o),D[n]=a-M}const at=Math.max(2,Math.min(5e3,Number.isFinite(t.maxPoints)?t.maxPoints:500)),z=Math.min(at,s),G=(n,a)=>{if(a<=0)return n[0];const f=Math.floor(a),P=Math.min(n.length-1,f+1),h=a-f;return(1-h)*n[f]+h*n[P]},X=[];for(let n=0;n<z;n++){const a=z===1?0:n/(z-1),f=a*(s-1),P=a*m,h=M+G(D,f),B=(()=>{const I=Math.floor(f);let x=0;for(let A=0;A<=I;A++)x+=N[A]*o;const O=f-I;return I+1<N.length&&(x+=N[I+1]*o*O),x})(),g=G(N,f),J=G(K,f);X.push({time:P,pointTemp:h,cumulativeEnergy:B,power:g,velocity:J})}return X}self.onmessage=t=>{const o=t.data;try{const m=Z(o);postMessage(Array.isArray(m)?m:[])}catch{postMessage([])}}})();
